.. include:: tools/github_ribbon.rst

Steam in-home streaming как это работает и нужно ли оно мне?
============================================================
.. contents:: :local:
   :depth: 3


Для кого эта статья?
--------------------
Труд, как и первая его `часть <http://blacklibrary.ru/docs/steamos.html>`_, рассчитан на пользователей персонального компьютера (далее ПК), тем не менее убежденным консольным игрокам читать не воспрещается.
Порог вхождения в тематику будет сохранен и представлен от технически подкованного пользователя, до новичка в сфере информационных технологий и программного обеспечения. Тем не менее главный критерий - уверенный ПК геймер.


Железо и Софт
-------------
Steam in-home streaming будет тестироваться на следующей аппаратной конфигурации.

**Windows 7/SteamOS**::

    * Intel Core i7 4770k
    * 8 GB RAM DDR3
    * ATI/AMD R9 280x 3GB DDR5

**Gentoo**::

    * Intel Core i5
    * 6GB RAM DDR3
    * Nvidia 730GTX

Также помимо **ATI/AMD R9 280x** будет использованы: *Nvidia GTX650 Ti*, *Radeon HD6850* но несколько в меньшей степени.

Общие сведения о стриминге
--------------------------
Для того, чтобы ворваться в in-home streaming от Valve в Steam'е было бы не плохо понять что же это примерно такое, а также, что необходимо для того, чтобы все работало как нужно.

Что такое стриминг и как это работает?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Стриминг или как нам может сказать wikipedia `потоковое мультимедия <http://ru.wikipedia.org/wiki/%D0%9F%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%B2%D0%BE%D0%B5_%D0%BC%D1%83%D0%BB%D1%8C%D1%82%D0%B8%D0%BC%D0%B5%D0%B4%D0%B8%D0%B0>`_ - это способ *непрерывный* способ передачи информации по какому-либо доступному каналу. Если не вдваваться глубоко в детали, то звучать это будет приблизительно так. Что на самом деле это значит догадаться не сложно, будь то просмотр видео или стрима на youtube, прослушивание радио передачи через интернет, все это будет обеспечиваться с помощью передачи данных в потоке (stream - поток). В сущности ничего сложного в этом нет, тем не менее стриминг какого-то интерактивного контента, т.е. игр, не производилось вплоть до 2010 года. Почему так?

Не могу точно сказать, в чем же была сложность или невозможность появления для широкого пользователя раньше, но мне кажется из-за того, что в этом не было особой нужды, ++да и облачные технологии начали набирать обороты незадолго до того, как появился первый продукт на рынке потокового вещания игр `OnLive <http://ru.wikipedia.org/wiki/OnLive>`_. На самом деле сейчас это не так важно, почему этого не было раньше, важно то, что происходит сейчас.

<картиночки>

Steam in-home streaming
```````````````````````
Steam in-home streaming (далее стриминг) работает на той же основе что и потоковое мультимедия вещание, за одним исключением, помимо передачи аудио и звука передается еще и данные пользовательского ввода - ползание мышки по коврику, нажатие клавиш на клавиатуре, мышке, геймпаде, вращения осей руля и так далее. Также из особенностей стриминга игр стоит выделить тот факт, что клиент не может заносить/сохранять данные в буфере, так как интерактивная составляющая данного типа стриминга просто не позволяет такой роскоши. Звучит очень сложно и запутанно, но все гораздо проще выглядит на экране компьютера или любого устройства, которое принимает данные от сервера.
Если при просмотре видео, прослушивания аудио мы можем управлять только позицией с которой хотим начать или продолжить смотреть и слушать, то в игре мы управляем куда большим *наименованием объектов*. Разумеется, если видео ролик можно буферизировать без опаски, то геймплей буферизировать нет возможности. И эта особенность является чуть ли не ключевой во всем вопросе потокового вещания интерактивного контента - игр.

Потоковое вещание в Steam реализовано внутри локальной сети, то есть одинм из серверов, которые будут передавать данные будет выступать один из ваших компьютеров.

<картинки тут>

Nota bene
`````````
С помощью стриминга или потокового вещания можно передавать данные из одного места в другое как есть без видимых или ощутимых задержек, по установленному каналу обмена данными, например Интернет.

Список требований по программному и аппаратному обеспечению
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Для того, чтобы осуществить передачу данных из точки А в точку Б будет необходимо иметь источник, приемник а также канал связи, который будет соединять А и Б. Отойдем от абстракции к конкретике: в качестве источника будет выступать устройство, на котором будет запущена игра, в качестве приемника будет выступать к примеру ноутбук, steam machine или что-нибудь похожее, в качестве канала связи может быть домашняя сеть - wifi роутер, с подключенными к нему компьютерами и другими устройствами.
< картинка с топологией сети >
Поэтому из аппаратного обеспечения потребуется:

* Сервер - конфигурация игрового комьютера, она может быть любой на ваш вкус, в моем случае это:
    * Intel i7 4770k
    * 8 GB RAM DDR3
    * R9 290x
    * Монитор LCD LED Samsung 23" 1920x1080 (1080p)
* Клиент - в этом случае может выступать менее мощный компьютер, в моем случае это:
    * Intel i5 *ы какой?*
    * 6 GB RAM DDR3
    * NVIDIA 730M
    * LCD Дисплей 1920x1080 (1080p)
* Канал связи - для того чтобы шли данные с одного комьютера на другой:
    * LAN 100Mbit/s или WLAN (Wifi) 130Mbit/s (802.11n) - наличие обоих каналов не обязательно, хватит и одного. Я буду использовать оба посменно.

Моя конфигурация довольно дорогая и на её построение уйдет довольно много денег, поэтому я сразу напишу обоснование тому, что критично необходимо для осуществления стриминга (сервер) и прослушивания потока (клиент).

Расчеты
```````
Для сервера, все просто, если вы хотите стримить игры на подобии Crysis, Battlefield, то соответственно вам потребуются рекомендуемые разработчиками системные требования.
С клиентом все несколько не очевидно, поэтому приступим к разбору необходимых технологий, чтобы понять что именно нам нужно на клиентской машине.

FullHD или HD?
``````````````
Нет смысла объяснять консольным игрокам в чем отличие Full HD от HD формата, если кто-то и не знает точного ответа, то понимает это головой. `FullHD <http://ru.wikipedia.org/wiki/Full_HD>`_ формат разрешения 1920x1080 или 1080 с буквой p или i - 1080p, 1080i. Это значит, что картинка будет занимать 1920 помноженное на 1080 пикселей, это в итоге целых 2 мегапикселя!
Но это еще не все, для того чтобы картинка двигалась необходимо её менять, частота кадров в секунду или frames per second (FPS) также жизненно необходимы для комфортного просмотра кино, а также игры в это кино, если вы понимаете о чем я.
Пользуясь не хитрыми подсчетами 1920 * 1080 * 60 = 124 416 000 пикселей в секунду. Если учесть что 1 пиксель это 24bit, то в итоге получается очень большая сумма 2985984000 бита или 355 мегабайт.
Знаю, что многие удивятся, многие запротестуют и скажут, что это наглая ложь, к счастью они окажутся правыми, так как для того чтобы передать картинку в 1080p не нужно такго чудовишного канала.
Как и любые потоковые данные видеопоток и аудиопоток подвергается кодированию и уменьшению по своему объему передаваемой информации.

Проводить подробное объяснение как осуществляется кодирование сигнала, ровно как и рассказывать о массе различных тонкостях я здесь не буду, об этом стоит почитать отдельно <ссылку на отдельно>. Тем не менее некоторую позновательную информацию я озвучу, чтобы пользователь понимал с чем сталкивается.

В случае с видео в качестве *кодирующего механизма* могут выступать различные кодеки, например `H.264 <http://ru.wikipedia.org/wiki/H.264>`_, которые позволяют сжимать видео поток без потери качества. Кодеков на самом деле много, но приводить их все смысла нет. Рассмотрим на примере выбранного то, сколько примерно нам нужно будет канала, чтоб передать 1 кадр в секунду. Для этого можно просто обратиться к табличке, часть которой я представлю здесь, а полную верснию можно будет увидеть `тут <http://en.wikipedia.org/wiki/H.264/MPEG-4_AVC#Levels>`_.

+------------------------------------------------+-----------------------+
|Максимальная скорость видеопотока (VCL) кбит/c  |                       |
|                                                |                       |
+-------------------+--------------+-------------+Разрешение @ наиболее  |
|Baseline, Extended | High Profile | High 10     |высокий фреймрейт      |
|and Main Profiles  |              | Profile     |                       |
+===================+==============+=============+=======================+
| 20.00             | 25.000       |   60.000    | * 1280x720 @68.3      |
|                   |              |             | * 1920x1080 @30.1     |
+-------------------+--------------+-------------+-----------------------+
| 50.000            | 62.500       | 150.000     | * 1280x720 @145.1     |
|                   |              |             | * 1920x1080 @64.0     |
+-------------------+--------------+-------------+-----------------------+
| 135.000           | 168.750      | 405.000     | * 1920x1080 @64.0     |
|                   |              |             | * 2560x1920 @30.7     |
+-------------------+--------------+-------------+-----------------------+

Если приглядеться к таблице возможно обнаружить что от повышения размера кодируемого изображения и `фреймрейта (кадровой частоты) <http://ru.wikipedia.org/wiki/%D0%9A%D0%B0%D0%B4%D1%80%D0%BE%D0%B2%D0%B0%D1%8F_%D1%87%D0%B0%D1%81%D1%82%D0%BE%D1%82%D0%B0>`_ зависит и скорость видеопотока, это та скорость с которой видеопоток можно передавать без задержек и предварительной буферизации. Из этой же табличке можно уяснить, чем ниже разрешение или фреймрейт, тем меньше нагрузки на канал передачи данных.

Теперь, если еще раз сверится с табличкой и запустить ``calc`` или любой удобный вам калькулятор вполне можно расчитать какой канал необходим для того, чтобы без заддержек передавать картинку/звук указанного качества с указанным фреймрейтом.
Я возьму показатели высокого порога для разрешения 1920x1080 @64 - это 150.000 кбит/c:

    15 0000 / 1000 = 150 Mbit/s

    60 000 / 1000 = 60 Mbit/s

Довольно большой показатель, хотя любая домашняя сеть, построенная на витой паре (кабель, обычно белого цвета, для тех кто не знает, что такое витая пара) или wi-fi роутере 802.11n стандарта (до 150Mbit/s, стандарт 802.11bg даёт 54Mbit/s). В пределах дома это вполне адекватное требование на мой взгляд.

По неофициально информации пользователей steam Valve использует как раз H.264 для кодирования видео/аудио. Правда официально данная информация ничем не подтверждена, думаю в будущем будет ясно что именно обеспечивает сжатие видео-аудио потоков.
Если сопоставить настройки от Valve и таблицу-профиль H.264 выше, то можно сделать вывод, что для стриминга 1920x1080 @60 fps у Valve нет возможности, так как максимальный показатель скорости канала в Steam сейчас установлен в 20 Mbit/s

.. image:: ../screens/streaming/steam/thumbnails/01.png
    :target: ../screens/streaming/steam/01.png

Но пока оставим эти все неясные тонкости и перейдем к следующему. Главное для понимания процесса стриминга сейчас то, что:

* Есть ПК-сервер, который запускает игру и передает видео и аудио потоки в сжатом формате
* Есть ПК-клиент, который принимает видео и аудио поток в сжатом формате
* Есть какой-либо способ соединения этих ПК в сеть

Задержка (latency)
``````````````````
Немного скомкано, но вполне быстро, мы разобрали что из себя представляет стриминг и что для этого нужно, за областью рассмотрения остался еще один немаловажный аспект - **задержка**. Если вспомнить серии Online Gamer (Задрот в отчественной локализации от колектива `stopgame <http://stopgame.ru>`_), то можно вспомнить как он орёт: "Лаг, лаг, лаг!!!" в те моменты, когда человек находится в мощной фрустрации/смущении и не может быстро и объективно реагировать, ровно как и в те моменты, когда главному герою - Эрону действительно что-то невтерпеж. Так вот лаг - это и есть реакция на задержку, как правило негативное, само по себе lag переводится как задержка или запаздывание. Если задержка довольно большая и ощутима пользователем, то это крайне плохо.

"Что же делать в этом случае?", - заинтересуются многие. Ответ на это прост, помимо скорости (так называемому объему данных, которое может быть передано за количество времени равному 1-ой секунде, например 100 Mbit/s), существует и скорость ответа запрашиваемого ресурса. Часто это называют пингом, хотя единицы отвят почему это не совсем правильно. Итак пинг или задержка (latency) будет показателем скорости реакции на наши действия. Так к примеру люди предпочитают играть на серверах с маленькой задержкой или с маленьким пингом, только потому что с большим пингом появляются артефакты в игре, которые делают абсолютно неконфортным времяприпровождение, а это могут быть:

* фризы - когда картинка подвисает, прерывается звук или прерывается управление
* лаги - очень долгая реакция на ввод игроком и ответная реакция нашего компьютерного альтерэго

Уверен, что некоторые уже догадались к чему я веду, но многие 100% не найдут связи между предыдущим пунктом и данным. Она есть, в этом и заключается сама суть стриминга игр с одного компьютера на другой.
Игрой необходимо управлять, нажимая на клавиши клавиатуры, дергая мышкой туда-сюда, тыкая клавишы геймпада и так далее. Если кто-то играл в Dawn of War 2 в интернетах, тот меня поймет быстро (если не играли смотрите этот `обзор <http://link/should/be/here/>_`, чтобы понять о чем я говорю).

Для того, чтобы осуществлять стриминг игры мало располагать хорошим каналом в ширену которого влезет видео и аудио потоки, необходимо еще, чтобы этот канал был достаточно быстрым. Например в условиях домашней сети я могу изучить какова средняя задержка между моим ноутбуком и целевым компьютером, на котором установлены игры (так уж вышло, что Windows 7+ может блокировать входящий ping даже внутри локальной сети, поэтому можно пингануть ближайшее устройство в сети, например роутер, как это сделал я):

.. code-block::

    PING 192.168.1.1 (192.168.1.1) 56(84) bytes of data.
    64 bytes from 192.168.1.1: icmp_seq=1 ttl=64 time=0.894 ms
    64 bytes from 192.168.1.1: icmp_seq=2 ttl=64 time=0.990 ms
    64 bytes from 192.168.1.1: icmp_seq=3 ttl=64 time=0.911 ms
    64 bytes from 192.168.1.1: icmp_seq=4 ttl=64 time=1.01 ms

В целом зеленая линия по задержке заканчивается к 100ms, но вполне сохраняется играбельной еще до уровня 130ms, хотя для разных игр разумеется по разному. Будем считать, что задержка 100ms будет является верхней планкой для адекватности результата.

Железо и прочее
```````````````
Чем шире канал, чем ниже задержка - тем быстрее будет передаваться контент на вашу сторону. Разумеется ограничения накладываются не только на представленные выше параметры, но также и на аппаратную (железную) часть вашего ПК.
В целом любая домашняя сеть, даже собранная на Wi-Fi со скоростью 54Mbit/s с головой хватает, чтобы удовлетворять требованиям стриминга, но удовлетворит ли железо? В этом мы будем разбираться детально чуть ниже, гоняя всевозможные проекты, пытаясь понять что к чему, а пока небольшая справочная информация.

Как я уже упоминул чуть выше о том, что потоки кодируются, то соответственно их надо чем-то кодировать и декодировать. Со сторны декодирования, а им будет заниматься компьютер, куда будет осуществляться стриминг, все просто достаточно среднего процессора или видеокарты с возможностью аппаратной поддержки декодирования видео. Подробнее об этом можно читать в интернетах много интересной и не очень документации/форумов/статей.

Большее внимание уделяется именно кодированию сигнала, к счастью, во многих современных картах поддержка аппаратного кодирования видео уже встроена, например Nvidia Shadow Play работает именно таким образом. И Nvidia и AMD имеют возможность к аппаратному кодированию видео на лету.

К сожалению я не нашёл никакой информации о том каким именно способом Valve кодирует потоки для отправки, по поводу декодирования их на стороне клиента будут доступны: `DXVA2 <http://ru.wikipedia.org/wiki/DirectX_Video_Acceleration>`_ (для Windows), `VDPAU <http://en.wikipedia.org/wiki/VDPAU>`_ (для Linux), `OpenMAX <http://ru.wikipedia.org/wiki/OpenMAX>`_ (Windows, Linux) и `VA-API <http://en.wikipedia.org/wiki/Video_Acceleration_API>`_ (Linux)


Установка, настройка
~~~~~~~~~~~~~~~~~~~~
По части установки необходимо переключиться в бета профиль Steam

.. image:: ../screens/streaming/steam/thumbnails/02.png
    :target: ../screens/streaming/steam/02.png

И настроить необходимые параметры во вкладке **Домашний стриминг**. Рекомендую поиграться всем с параметрами в 1080p/720p и 30fsp/60fps, для того чтобы установить оптимальный режим.

.. image:: ../screens/streaming/steam/thumbnails/03.png
    :target: ../screens/streaming/steam/03.png

Тестирование in-home streaming
------------------------------
Тестирование будет проходить в двух из трех возможных режимах, это 720p и 1080p для топового железа (R9 280x) и преимущественно в 720p для остальных железок с выбором 1080p в некоторых случаях.


Другие стриминговые платформы
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Коротко рассказать о других стриминговых платформах

Список игр
~~~~~~~~~~
*если вас заинтересует какая-то конкретная игра, которой нет в списке, то дайте об этом знать, я постараюсь её тоже прогнать, к сожалению я не имею возможности прогонять всю свою библиотеку, потому что тест затянется на очень большое время + сейчас я очень ограничен в возможностях по загрузке*
Windows 7 (в скобочках доступные игры в SteamOS означают, что игра будет стримиться еще и со SteamOS)

Также будут попытки запустить что-то не из Steam библиотеки, список уже будет опубликован в статье.
+ Точно будут и другие игры в списке, которые будут стримиться с ноутбучного железа.

Warhammer 40.000: Dawn of War 2
````````````````````````````````
При ультра настройках Dawn of War 2, Chaos Rising и Retribution показали себя полне адекватно на стартовых миссиях, хотя количество fps при 1080p было не больше 30 fps при самой игре, не просядая ниже в ответственные моменты. Примечателен тот факт, что загрузка GPU не поднималась выше 40%, ровно как и нагрузка на CPU была средней, не выше 50% на каждое из ядер/потоков.


Warhammer 40.000: Space Marine
``````````````````````````````
В целом мне удалось даже пройти компанию, с помощью стриминга. В целом замечаний особо нет, кроме одной. 1080p в основном идет при частоте 30 fps в авто режиме и 45-50, если частоту кадров устанавливать в 60fps. Также можно отметить тот факт, что при при любой внезапной загрузки компа качество сильно падает до неиграбельного состояния. Опыт оцениваю как положительный.


Company of Heroes 2
```````````````````
<test data>

Mortal Kombat 9
```````````````
<test data>

Batman: Arkham Origins
``````````````````````
<test data>

Dark Souls: Prepare to Die edition
``````````````````````````````````
<test data>

DarkSiders II
`````````````
<test data>

Dead Island
```````````
<test data>

Skyrim
``````
<test data>

Dota 2 (SteamOS)
````````````````
<test data>

Left 4 Dead 2 (SteamOS)
```````````````````````
<test data>

Team Fortress 2 (SteamOS)
`````````````````````````
<test data>

Half-Life 2 (SteamOS)
`````````````````````
<test data>

Portal 2
````````
<test data>

Torchlight 2
````````````
<test data>

Brutal Legend (SteamOS)
```````````````````````
<test data>

Alan Wake
`````````
<test data>

Chaos on Deponia
````````````````
<test data>

Fallout, Fallout 2
``````````````````
<test data>

Fallout: New Vegas
``````````````````
<test data>

Counter Strike: Global Offensive
````````````````````````````````
<test data>

Bioshock
````````
<test data>

Magicka
```````
<test data>

Castlevania: Lords of Shadow
````````````````````````````
<test data>

Deadlight
`````````
<test data>

FEZ (SteamOS)
`````````````
<test data>

Prime World
```````````
<test data>

DeathSpank
``````````
<test data>

The Witcher
```````````
<test data>

The Witcher 2
`````````````
<test data>

Serious Sam 3: BFE (SteamOS)
````````````````````````````
<test data>

Hitman absolution
`````````````````
<test data>

Don't Starve (SteamOS)
``````````````````````
<test data>

Commandos: Beyond the Call of Duty
``````````````````````````````````
<test data>

Metro 2033
``````````
<test data>

Metro Last Light (SteamOS only)
```````````````````````````````
<test data>

Natural Selection 2 (SteamOS)
`````````````````````````````
<test data>

Итоги тестирования
------------------
Итоги по результатам тестирования

Перспективы и аналитика
-----------------------
Перспективы стриминга + диванная аналитика, что из этого можно выжать